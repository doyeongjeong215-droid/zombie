<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zombie Tide - Keyboard MVP</title>
    <style>
      :root {
        --bg: #08111f;
        --panel: #10223f;
        --panel2: #19345e;
        --accent: #ffb703;
        --ok: #12d6a4;
        --warn: #ff4d6d;
        --text: #edf2f4;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        background: radial-gradient(circle at top, #15315a 0%, var(--bg) 58%);
        color: var(--text);
        font-family: "Pretendard", "Noto Sans KR", system-ui, sans-serif;
      }
      .wrap {
        max-width: 1180px;
        margin: 0 auto;
        padding: 16px;
        display: grid;
        gap: 14px;
        grid-template-columns: 2fr 1fr;
      }
      .card {
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.15);
        background: linear-gradient(180deg, var(--panel), var(--panel2));
        padding: 12px;
      }
      h1,h2,p { margin: 0 0 8px; }
      .muted { opacity: .85; font-size: 14px; }
      canvas {
        width: 100%;
        height: auto;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,.2);
        background: #07101f;
        image-rendering: pixelated;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(2,minmax(0,1fr));
        gap: 8px;
        margin: 8px 0;
      }
      .s {
        background: rgba(255,255,255,.08);
        border-radius: 8px;
        padding: 8px;
        font-size: 13px;
      }
      .v { font-size: 19px; font-weight: 700; }
      .log { max-height: 540px; overflow:auto; font-size: 13px; line-height: 1.35; }
      .log p { margin: 0 0 7px; }
      .tag { display:inline-block; font-size:11px; border-radius:999px; padding:2px 6px; margin-right:5px; }
      .act { background: rgba(255,183,3,.28); }
      .ok { background: rgba(18,214,164,.28); }
      .warn { background: rgba(255,77,109,.30); }
      @media (max-width: 980px) { .wrap { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <div class="wrap">
      <section class="card">
        <h1>ğŸ§­ Zombie Tide (í‚¤ë³´ë“œ ì‹¤ì‹œê°„ MVP)</h1>
        <p class="muted">WASD/ë°©í–¥í‚¤ ì´ë™ Â· <b>Space</b> ìƒí˜¸ì‘ìš©/ê³µê²© Â· <b>Shift</b> ë‹¬ë¦¬ê¸°</p>
        <canvas id="game" width="832" height="544"></canvas>
        <div class="stats" id="stats"></div>
      </section>
      <section class="card">
        <h2>ğŸ“œ ë¡œê·¸</h2>
        <p class="muted">ìŠ¤íƒ€ë“€ë°¸ë¦¬ì²˜ëŸ¼ ì´ë™í•˜ë©´ì„œ êµ¬ì—­ì— ì ‘ê·¼í•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.</p>
        <div class="log" id="log"></div>
      </section>
    </div>

    <script>
      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");
      const logEl = document.getElementById("log");
      const statsEl = document.getElementById("stats");

      const W = canvas.width, H = canvas.height;
      const keys = new Set();
      const state = {
        day: 1, dayTime: 0, dayLength: 120,
        food: 50, materials: 40, stamina: 100, memory: 50,
        fear: 18, infection: 0, defense: 18, farm: 100, livestock: 6,
        hp: 100, shipFound: false, shipProgress: 0, atSea: false, seaTimer: 0,
        zombies: [], spawnTick: 0, interactCd: 0, hitCd: 0,
      };
      const player = { x: 416, y: 300, r: 11, speed: 160, dir: 0 };

      const zones = {
        farm: { x: 80, y: 330, w: 170, h: 130, name: "ë†ì¥" },
        workshop: { x: 295, y: 340, w: 130, h: 105, name: "ì‘ì—…ëŒ€" },
        rest: { x: 445, y: 355, w: 110, h: 95, name: "íœ´ì‹ì²˜" },
        tower: { x: 585, y: 315, w: 145, h: 145, name: "ë°©ì–´íƒ‘" },
        beach: { x: 620, y: 90, w: 165, h: 130, name: "í•´ì•ˆ" },
        dock: { x: 80, y: 90, w: 155, h: 125, name: "ì„ ì°©ì¥" },
      };

      function log(msg, type="act") {
        const p = document.createElement("p");
        p.innerHTML = `<span class="tag ${type}">${type.toUpperCase()}</span>${msg}`;
        logEl.prepend(p);
      }
      const clamp=(v,a,b)=>Math.max(a,Math.min(v,b));
      const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
      const act = ()=> state.day<=15?1:state.day<=30?2:3;
      function near(zone){ return player.x>zone.x&&player.x<zone.x+zone.w&&player.y>zone.y&&player.y<zone.y+zone.h; }

      function action() {
        if (state.interactCd > 0) return;
        state.interactCd = 0.24;

        if (near(zones.farm)) {
          const gain = rnd(6,12)+Math.floor(state.farm/25);
          state.food += gain; state.stamina -= 5;
          log(`ë†ì‚¬ ìˆ˜í™• +${gain} ì‹ëŸ‰`, "ok"); return;
        }
        if (near(zones.workshop)) {
          if (state.materials < 6) { log("ìì¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", "warn"); return; }
          state.materials -= 6; state.defense += rnd(3,7); state.stamina -= 7;
          if (state.shipFound) state.shipProgress = clamp(state.shipProgress + rnd(4,10), 0, 100);
          log("ì œì‘ ì™„ë£Œ: ë°©ì–´ ê°•í™”/ì„ ì²´ ìˆ˜ë¦¬ ì§„í–‰", "ok"); return;
        }
        if (near(zones.rest)) {
          if (state.food < 4) { log("ì‹ëŸ‰ì´ ë¶€ì¡±í•´ íœ´ì‹ íš¨ìœ¨ì´ ë‚®ìŠµë‹ˆë‹¤.", "warn"); }
          state.food = Math.max(0, state.food-4); state.stamina = clamp(state.stamina+20,0,100); state.memory = clamp(state.memory+7,0,100);
          log("íœ´ì‹ìœ¼ë¡œ ê¸°ë ¥ê³¼ ê¸°ì–µë ¥ íšŒë³µ", "act"); return;
        }
        if (near(zones.tower)) {
          if (state.materials < 5) { log("í•¨ì • ì„¤ì¹˜ ì‹¤íŒ¨: ìì¬ ë¶€ì¡±", "warn"); return; }
          state.materials -= 5; state.defense += 12; state.fear = clamp(state.fear-5,0,100);
          log("ìë™ ë°©ì–´ ì„¤ë¹„ë¥¼ ì¦ì„¤í–ˆìŠµë‹ˆë‹¤.", "ok"); return;
        }
        if (near(zones.beach)) {
          state.stamina -= 8; state.memory += rnd(2,7); state.materials += rnd(4,9);
          if (!state.shipFound && Math.random() < 0.4) { state.shipFound = true; log("ë‚œíŒŒì„ ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤! ë°° ìˆ˜ë¦¬ ê°€ëŠ¥", "act"); }
          else log("í•´ì•ˆ íƒìƒ‰: ìì¬ì™€ ë‹¨ì„œ ìˆ˜ì§‘", "act");
          return;
        }
        if (near(zones.dock)) {
          if (!state.shipFound || state.shipProgress < 100) { log("ë°° ìƒíƒœ ë¶€ì¡±: ë°œê²¬/ìˆ˜ë¦¬ í•„ìš”", "warn"); return; }
          if (state.atSea) { log("ì´ë¯¸ ì›ì • ì¤‘ì…ë‹ˆë‹¤.", "warn"); return; }
          state.atSea = true; state.seaTimer = 28; state.food = Math.max(0,state.food-10); state.stamina = clamp(state.stamina-10,0,100);
          log("â›µ ì™¸í•´ ì›ì • ì‹œì‘! ì„¬ì€ ìë™ ë°©ì–´ì— ë§¡ê²¨ì§‘ë‹ˆë‹¤.", "act");
          return;
        }

        // êµ¬ì—­ì´ ì•„ë‹ˆë©´ ê³µê²©
        let target = null, min = 9999;
        for (const z of state.zombies) {
          const d = Math.hypot(player.x-z.x, player.y-z.y);
          if (d < 52 && d < min) { min = d; target = z; }
        }
        if (target) {
          target.hp -= 40;
          state.stamina = clamp(state.stamina - 3, 0, 100);
          log("ì¢€ë¹„ë¥¼ ê³µê²©í–ˆìŠµë‹ˆë‹¤.", "ok");
        }
      }

      function spawnZombie() {
        const edge = rnd(0,3);
        let x=0,y=0;
        if (edge===0){x=rnd(0,W);y=-10;} if (edge===1){x=W+10;y=rnd(0,H);} if (edge===2){x=rnd(0,W);y=H+10;} if (edge===3){x=-10;y=rnd(0,H);} 
        state.zombies.push({x,y,hp:100,speed:rnd(35,58)});
      }

      function dailyTick() {
        state.day += 1;
        state.food -= 8;
        state.stamina = clamp(state.stamina - 4, 0, 100);
        state.memory = clamp(state.memory - (state.atSea?6:2), 0, 100);
        if (state.food <= 0) { state.food = 0; state.infection += 6; state.fear += 8; log("ì‹ëŸ‰ ê³ ê°ˆ! ê°ì—¼ê³¼ ê³µí¬ ì¦ê°€", "warn"); }
        if (state.memory < 20) state.fear += 4;

        if (!state.shipFound && state.day >= 8 && state.memory >= 35) {
          state.shipFound = true; log("ì ˆë²½ ì•„ë˜ ë‚œíŒŒì„ ì„ ì°¾ì•„ëƒˆìŠµë‹ˆë‹¤.", "act");
        }
        if (state.shipFound && state.shipProgress >= 40 && state.day > 15 && state.day <= 30) {
          log("ì „ê¸°/í™”ê¸° ê¸°ìˆ  í•´ê¸ˆ! ì¢€ë¹„ ëŒ€ì‘ë ¥ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.", "act");
        }
        if (state.infection > 35 && state.livestock > 0 && Math.random() < 0.35) {
          state.livestock -= 1; log("ê°€ì¶• ì¢€ë¹„í™” ë°œìƒ!", "warn");
        }
      }

      function update(dt) {
        state.dayTime += dt;
        if (state.dayTime >= state.dayLength) { state.dayTime = 0; dailyTick(); }
        if (state.interactCd > 0) state.interactCd -= dt;
        if (state.hitCd > 0) state.hitCd -= dt;

        const run = keys.has("Shift") && state.stamina > 0;
        const speed = player.speed * (run ? 1.45 : 1);
        if (run) state.stamina = clamp(state.stamina - 13 * dt, 0, 100);

        let dx = 0, dy = 0;
        if (keys.has("ArrowUp") || keys.has("w")) dy -= 1;
        if (keys.has("ArrowDown") || keys.has("s")) dy += 1;
        if (keys.has("ArrowLeft") || keys.has("a")) dx -= 1;
        if (keys.has("ArrowRight") || keys.has("d")) dx += 1;
        if (dx || dy) {
          const l = Math.hypot(dx,dy); dx/=l; dy/=l;
          player.x = clamp(player.x + dx*speed*dt, 18, W-18);
          player.y = clamp(player.y + dy*speed*dt, 18, H-18);
          player.dir = Math.atan2(dy,dx);
        }

        const isNight = state.dayTime > state.dayLength * 0.55;
        if (isNight) {
          state.spawnTick += dt;
          const interval = clamp(3.2 - state.day*0.04, 1.1, 3.2);
          if (state.spawnTick >= interval) { state.spawnTick = 0; spawnZombie(); }
        }

        const target = {x: zones.farm.x+zones.farm.w/2, y: zones.farm.y+zones.farm.h/2};
        for (const z of state.zombies) {
          const tx = player.x, ty = player.y;
          const distP = Math.hypot(z.x - tx, z.y - ty);
          const chaseP = distP < 130;
          const gx = chaseP ? tx : target.x, gy = chaseP ? ty : target.y;
          const vx = gx - z.x, vy = gy - z.y;
          const l = Math.max(1, Math.hypot(vx,vy));
          z.x += (vx/l) * z.speed * dt;
          z.y += (vy/l) * z.speed * dt;

          if (Math.hypot(z.x-player.x, z.y-player.y) < 18 && state.hitCd <= 0) {
            state.hitCd = 0.8;
            state.hp = clamp(state.hp - 6, 0, 100);
            state.fear = clamp(state.fear + 2, 0, 100);
            log("ì¢€ë¹„ì—ê²Œ í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤!", "warn");
          }
          if (z.x > zones.farm.x && z.x < zones.farm.x+zones.farm.w && z.y > zones.farm.y && z.y < zones.farm.y+zones.farm.h) {
            state.farm = clamp(state.farm - 7 * dt, 0, 100);
          }
        }
        state.zombies = state.zombies.filter(z => z.hp > 0);

        if (state.atSea) {
          state.seaTimer -= dt;
          if (Math.random() < 0.02 * dt) {
            const dmg = rnd(4,11);
            state.farm = clamp(state.farm-dmg,0,100);
            state.infection = clamp(state.infection+rnd(1,4),0,100);
            log(`ì›ì • ì¤‘ ê¸°ì§€ ìŠµê²©! ë†ì¥ ${dmg}% í”¼í•´`, "warn");
          }
          if (Math.random() < 0.018 * dt) {
            const loot = rnd(6,14);
            state.materials += loot;
            state.memory = clamp(state.memory + 3, 0, 100);
            log(`ì™¸í•´ ì„±ê³¼ +${loot} ìì¬`, "ok");
          }
          if (state.seaTimer <= 0) { state.atSea = false; log("ì›ì • ê·€í™˜ ì™„ë£Œ", "act"); }
        }

        state.fear = clamp(state.fear - 0.35*dt, 0, 100);
        state.infection = clamp(state.infection, 0, 100);

        if (state.hp <= 0 || state.farm <= 0 || state.infection >= 100) {
          log("ì½œë¡œë‹ˆ ë¶•ê´´. ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì¬ì‹œì‘í•˜ì„¸ìš”.", "warn");
          cancelAnimationFrame(loopId);
        }
      }

      function rect(z, c) { ctx.fillStyle = c; ctx.fillRect(z.x, z.y, z.w, z.h); }
      function draw() {
        const isNight = state.dayTime > state.dayLength * 0.55;
        ctx.fillStyle = isNight ? "#06101d" : "#0b1a2f";
        ctx.fillRect(0,0,W,H);

        rect(zones.farm, "#375a33");
        rect(zones.workshop, "#54657f");
        rect(zones.rest, "#7b6548");
        rect(zones.tower, "#5a475f");
        rect(zones.beach, "#9d845f");
        rect(zones.dock, "#3b5a77");

        ctx.fillStyle = "rgba(255,255,255,.85)";
        ctx.font = "12px sans-serif";
        for (const z of Object.values(zones)) ctx.fillText(z.name, z.x+8, z.y+18);

        for (const z of state.zombies) {
          ctx.beginPath();
          ctx.fillStyle = "#b5179e";
          ctx.arc(z.x,z.y,10,0,Math.PI*2);
          ctx.fill();
        }

        ctx.beginPath();
        ctx.fillStyle = "#ffb703";
        ctx.arc(player.x,player.y,player.r,0,Math.PI*2);
        ctx.fill();
        ctx.strokeStyle = "#222";
        ctx.beginPath();
        ctx.moveTo(player.x, player.y);
        ctx.lineTo(player.x + Math.cos(player.dir)*16, player.y + Math.sin(player.dir)*16);
        ctx.stroke();

        if (isNight) {
          ctx.fillStyle = "rgba(0,0,0,.28)";
          ctx.fillRect(0,0,W,H);
        }
      }

      function renderStats() {
        const isNight = state.dayTime > state.dayLength*0.55;
        const txt = [
          ["Day / Act", `${state.day} / ${act()}`],
          ["ì‹œê°„", isNight?"ğŸŒ™ ì•¼ê°„":"â˜€ï¸ ì£¼ê°„"],
          ["HP", Math.round(state.hp)],
          ["ê¸°ë ¥", Math.round(state.stamina)],
          ["ì‹ëŸ‰", state.food],
          ["ìì¬", state.materials],
          ["ê¸°ì–µë ¥", Math.round(state.memory)],
          ["ë°©ì–´ë ¥", state.defense],
          ["ê°ì—¼ë„", state.infection],
          ["ê³µí¬", Math.round(state.fear)],
          ["ë†ì¥", Math.round(state.farm)],
          ["ì„ ë°•", state.shipFound ? `${state.shipProgress}%` : "ë¯¸ë°œê²¬"],
          ["ì›ì •", state.atSea ? `ì§„í–‰ì¤‘ ${Math.ceil(state.seaTimer)}s` : "ëŒ€ê¸°"],
          ["ì¢€ë¹„", state.zombies.length],
        ];
        statsEl.innerHTML = txt.map(([k,v])=>`<div class="s">${k}<div class="v">${v}</div></div>`).join("");
      }

      window.addEventListener("keydown", (e)=>{
        if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)) e.preventDefault();
        if (e.key === " ") action();
        keys.add(e.key.length===1?e.key.toLowerCase():e.key);
      });
      window.addEventListener("keyup", (e)=> keys.delete(e.key.length===1?e.key.toLowerCase():e.key));

      let last = performance.now(), loopId;
      function loop(now) {
        const dt = Math.min(0.033, (now-last)/1000);
        last = now;
        update(dt);
        draw();
        renderStats();
        loopId = requestAnimationFrame(loop);
      }

      log("ìƒì¡´ ì‹œì‘: êµ¬ì—­ìœ¼ë¡œ ì´ë™í•´ì„œ Spaceë¡œ ìƒí˜¸ì‘ìš©í•˜ì„¸ìš”.", "act");
      log("ëª©í‘œ: ë‚œíŒŒì„  ë°œê²¬ â†’ ìˆ˜ë¦¬ 100% â†’ ì„ ì°©ì¥ì—ì„œ ì›ì •.", "act");
      requestAnimationFrame(loop);
    </script>
  </body>
</html>
